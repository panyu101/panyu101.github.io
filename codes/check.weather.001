#!/bin/bash

for PLACE in CN.Haikou CN.Shanghai CA.Vancouver
  do
  CITY=${PLACE:3}
  COUNTRY=${PLACE:0:2}

  DATAFILE="/root/weather/$CITY.data"
  curl -s "http://api.openweathermap.org/data/2.5/weather?q=$CITY,$COUNTRY&units=metric&APPID=a5323bc6bcb8a5ba71ba95dfab44495b" > $DATAFILE
  TEMP=$(cat $DATAFILE | jq .main.temp)
  TEMPFEEL=$(cat $DATAFILE | jq .main.feels_like)
  HUMIDITY=$(cat $DATAFILE | jq .main.humidity)
  CLOUD=$(cat $DATAFILE | jq .clouds.all)

  case "$CITY" in
    Haikou)
      START=`date +"%s"`
      LON=110.34
      LAT=20.05
      #UVI=$(curl -s "http://api.openweathermap.org/data/2.5/uvi/history?lat=$LAT&lon=$LON&start=$START&end=$START&APPID=a5323bc6bcb8a5ba71ba95dfab44495b"|jq .[].value)
      #curl -s "http://api.openweathermap.org/data/2.5/uvi/history?lat=$LAT&lon=$LON&start=$START&end=$START&APPID=a5323bc6bcb8a5ba71ba95dfab44495b" > 000
      ;;
    Shanghai)
      START=`date +"%s"`
      LON=121.46
      LAT=31.22
      #UVI=$(curl -s "http://api.openweathermap.org/data/2.5/uvi/history?lat=$LAT&lon=$LON&start=$START&end=$START&APPID=a5323bc6bcb8a5ba71ba95dfab44495b"|jq .[].value)
      ;;
    Vancouver)
      START=`date +"%s"`
      LON=-123.12
      LAT=49.25
      #UVI=$(curl -s "http://api.openweathermap.org/data/2.5/uvi/history?lat=$LAT&lon=$LON&start=$START&end=$START&APPID=a5323bc6bcb8a5ba71ba95dfab44495b"|jq .[].value)
      ;;
    *)
      echo "$CITY has not specified!"
      exit 1
  esac

#echo "$CITY temp=$TEMP,tempfeel=$TEMPFEEL,humidity=$HUMIDITY,cloud=$CLOUD,uvi=$UVI"

#curl -i -XPOST "http://127.0.0.1:8086/write?db=weather" --data-binary "$CITY temp=$TEMP,tempfeel=$TEMPFEEL,humidity=$HUMIDITY,cloud=$CLOUD,uvi=$UVI"
curl -i -XPOST "http://127.0.0.1:8086/write?db=weather" --data-binary "$CITY temp=$TEMP,tempfeel=$TEMPFEEL,humidity=$HUMIDITY,cloud=$CLOUD"

done

