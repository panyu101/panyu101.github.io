#!/usr/bin/python

import sys
import re
import requests
import os
from time import sleep
from random import randint
from icecream import ic

current_place = '/var/nginx/html/.ent/96/'

processname = 'dld.ent.pic'
tmp = os.popen("ps -Af").read()
proccount = tmp.count(processname)

while proccount > 4:
	sleep(9)
	tmp = os.popen("ps -Af").read()
	proccount = tmp.count(processname)
	#print(proccount)

#quit()

def filler(number):
	i = number
	if i < 10 and i >= 0 :
		return str('00')
	elif i < 100 and i >= 10 :
		return str('0')
	elif i < 1000 and i >= 100 :
		return str('')


items = os.listdir(current_place)
items = sorted(items)
last_folder = int(items[-1]) + 1
last_folder = filler(last_folder) + str(last_folder)

#ic(items)
#ic(last_folder)
#quit()

os.makedirs(current_place + last_folder)

#for item in items:
#	this_item = current_place + item
#	if not os.path.isdir(this_item):
#		print(f'{this_item} {os.path.isdir(this_item)}')
#sys.exit()

#./976.curl.web.py https://www.nudecollect.com/content/NC_Beautiful_Models_20200609_Femjoy_2013_01_23_Misha_D_I_Am_Yours_70_Pics/image-1-pics-71-mirror-31.html
url=sys.argv[1]
#print(url)
url1 = re.sub('/image-.*', '/image-', url)
#print(url1)
mirror = re.findall('-mirror-.*.html', url, re.S)
mirror = re.sub('-mirror-', '', mirror[0])
mirror = re.sub('.html', '', mirror)
#print(mirror)
the_first = re.findall('image-.*-pics', url, re.S)
the_first = re.sub('image-', '', the_first[0])
the_first = int(re.sub('-pics', '', the_first))
#print(the_first)
the_last = re.findall('pics-.*-mirror', url, re.S)
the_last = re.sub('pics-', '', the_last[0])
the_last = int(re.sub('-mirror', '', the_last))
#print(the_last)
#sys.exit()
headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X10_14_5) AppleWebKit/537.36 (KHTML, kike Gecko) Chrome/83.0.4103.116 Safari/537.36'}

for i in range(the_first, the_last+1 ):
	url_html = url1 + str(i) + '-pics-' + str(the_last) + '-mirror-' + mirror + '.html'
	response = requests.get(url=url_html,headers=headers)
	if response.status_code == 200:
		res = response.content.decode()
		pic = re.findall('><img src=".*?.jpg', res, re.S)
		try:
			pic = re.sub('><img src="', 'https://www.nudecollect.com', pic[0])
		except IndexError:
			continue
		#print(f' {i} --- {pic}')
		file_name = current_place + last_folder + '/' + str(filler(i)) + str(i) + '.jpg'
		#print(f' {i} --- {file_name}')
		open(file_name, 'wb').write(requests.get(pic, allow_redirects=True).content)
		#print(f'{file_name} saved.')
		sleep(randint(1,9))
